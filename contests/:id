<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.3.1/jquery.maskedinput.js" type="text/javascript"></script>

<div class="content_container main_container mobile_padding padding_bottom_50">
    <div class="margin_25_across">
        <div class="row">
            <div class="col-md-12">
                <div id="events_not_empty_section">
                    <div class="" id="contest_container">
                        <script id="contest_template" type="x-tmpl-mustache">
                            <h4 class="promo_main_header ">{{name}}</h4>
                            <div class="promo-details">
                                <p class="hidden_now" id="succes_msg">Thank you! Your entry has been received.</p>
                                <div class="event-image">
                                    <img class="contest banner" src="{{alt_photo_url}}">
                                </div>
                                <br>
                                <div class="event-description">
                                    {{{ rich_description }}}
                                </div>
                                <br>
                            </div> 
                            <form id="contest_form" style="    margin-top: 10px;">
                                <input id="property_id" name="contest[property_id]" style="display:none" value="{{property_id}}"/>
                                <input id="contest_id" name="contest[contest_id]" style="display:none" value="{{id}}" />
                                <input type="hidden" name="cm-name" id="cm-name" />
                                <div class="row ">
                                    <div class="col-md-4 margin_30">
                                        <label for="first_name">First Name*</label><br/>
                                        <input id="first_name" type="text" name="contest[first_name]"required placeholder="First Name"  class="form-control" required data-validation="required" tabindex="1" />
                                    </div>
                                    <div class="col-md-4 margin_30">
                                        <label for="last_name">Last Name*</label><br/>
                <input id="last_name" type="text" name="contest[last_name]" required placeholder="Last Name" class="form-control" required data-validation="required" tabindex="2"/>
                                    </div>
                                    <div class="col-md-4 margin_30">
                                        <label for="email">Email*</label><br />
                <input id="email" name="contest[email]" type="text" required placeholder="Email" class="form-control" required data-validation-regexp="^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$" data-validation-error-msg="Please enter a valid email address" data-validation="custom" tabindex="3"/>
                                    </div>
                                </div>
                                <br class="hidden_phone">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="fieldjyiydk">Phone Number*</label><br />
                                        <input id="fieldjyiydk" name="cm-f-jyiydk" type="phone" class="form-control"  placeholder="Phone Number" required data-validation="required" tabindex="4"/>
                                       
                                    </div>
                                    <div class="col-md-8">
                                        
                                        <label for="fieldjyiyhr">Street Address</label><br />
                <input id="fieldjyiyhr" name="cm-f-jrihyh" type="text" placeholder="Street Address" class="form-control" tabindex="5"/>
                                    </div>
                                </div>
                                <br class="hidden_phone">
                                <div class="row ">
                                    <div class="col-md-4 margin_30">
                                        <label for="fieldjyiyhy">City</label><br />
                                        <input id="fieldjyiyhy" name="cm-f-jyiyhy" type="text" placeholder="City" class="form-control" tabindex="6" />
                                    </div>
                                    <div class="col-md-4 margin_30">
                                        <label for="fieldjyiydu">Postal Code*</label><br />
                                        <input id="fieldjyiydu" name="cm-f-jyiydu" type="text" placeholder="Postal Code" class="form-control" required data-validation="required" tabindex="7"/>
                                    </div>
                                    <div class="col-md-4 margin_30">
                                        <label for="fieldjyiyhl">Year of Birth*</label><br />
                                        <input id="fieldjyiyhl" name="cm-f-jyiyhl" type="text"  placeholder= "yyyy-mm-dd" class="form-control" required data-validation="required" tabindex="8"/>
                                    </div>
                                </div>
                                
                                <br>
                                <div class="row">
                                    <div class="col-md-12">
                                    <label for="enterVerify">Enter the following number below to proceed: <div id="verifyNum"></div></label><br>
                                        <input type="hidden" value="701469" id="verifyNumHidden" name="verifyNumHidden" />
                                        <input type="text" id="enterVerify" name="enterVerify" required tabindex="9" />
                                        <br/><br/>
                                        <!--<label class="agree">
                                            <input type="checkbox" class="info_check" id="newsletter_signup"/>&nbsp;Yes, I would like to receive ongoing news                                             related to events, promotions and special   
                                            announcements from Hazeldean Mall.
                                            <input id="newsletter_signup" type="checkbox" name="contest[newsletter]" requiredtabindex="7"/> 
                                            Yes, I would like to receive information about events and promotions from Hazeldean Mall.
                                        </label>-->
                                        <label for="newsletter_signup" style="display:none">Agree Terms</label>
                                        <input type="checkbox" class="info_check" required id="newsletter_signup"/>&nbsp;Yes, I would like to receive ongoing news                                              related to events, promotions and special   
                                        announcements from Hazeldean Mall
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                    <br/>
                                    <input type="checkbox" class="info_check" id="agree_terms" required/>&nbsp;I agree to the <a href = "/rules_regulations"><u>Rules and Regulations</u>
                                       <!--<a class="contest_link" href="/rules_regulations" target="_blank" tabindex="8">Click here</a> to view the rules and regulations.-->
                                        <br/><br/>
                                        <button class="text-center newsletter_btn animated_btn" type="submit" tabindex="9">Submit</button>
                                        <br/><br/>
                                        <br/><br/>
                                    </div>
                                </div>
                            </form>
                        </script>
                    </div>
                </div>
                <div id="events_empty_section" style="display:none;">
                    <p>Check back later for exciting contest details!</p>
                </div>
            </div>
        </div>  
    </div>
</div>

<script>
    $(document).ready(function(e) {
        init(e);
        function renderAll (){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var contestDetails = getContestBySlug(slug);
            console.log(contestDetails);
            if (contestDetails) {
                // renderPageData('#main_content','#contest_template',contestDetails, 'contestDetails')
                
                // $("#loading_screen").hide();
                // $("#main_content").fadeIn( "fast");
                randomgen();
                jQuery(function($){
                   $("#birthday").mask("9999/99/99");
                });
                $('#contest_form').submit(function (e) {
                    e.preventDefault();
                    if($('#enterVerify').val() == $('#verifyNumHidden').val() ) {
                        if ($("#agree_terms").prop("checked") == true){
                            var e = verify_required_fields();
                            if (e == true){
                                if ($("#newsletter_signup").prop("checked") == true){
                                    var s = check_email();
                                    if (s == true){
                                        var email = $("#email").val();
                                        $('input[name="cm-illljr-illljr"]').attr('value',email);
                                         $.getJSON(
                                            "//mobilefringe.createsend.com/t/d/s/illljr/?callback=?",
                                          $("#subForm").serialize(),
                                            function (data) {
                                                if (data.Status === 400) {
                                                    e.preventDefault();
                                                    alert("Please try again later.");
                                                } else { // 200
                                                    data = $("#contest_form").serialize();
                                                    submit_contest(data);
                                                      
                                                }
                                        });  
                                    } else {
            
                                        alert("Invaid E-mail address.")
                                    }
                                    
                                } else {
                                    data = $(this).serialize();
                                    submit_contest(data);
                                }    
                            } else {
                                alert("One or more required fields are blank! please fill in all fields marked with * and try again.")
                            }
                            
                            
                        } else {
                            alert("Please agree to the terms and conditions before submitting!")
                        }
                    }
                        else
                        {
                            alert("Please Enter Correct Verification Number");
                            randomgen();
                        }
                    
                    });
                } else {
                    $("#loading_screen").hide();
                    $("#404_msg").fadeIn( "fast");
                }
            
            
        }
        
        function submit_contest(data) {
            var propertyDetails = getPropertyDetails();
            var host = propertyDetails.mm_host
            var email = $("#email").val();
            var name = $("#first_name").val() + " " + $("#last_name").val();
            $('input[name="cm-name"]').attr('value',name);
            $('input[name="cm-illrkd-illrkd"]').attr('value',email);
            $.getJSON(
                "//mobilefringe.createsend.com/t/d/s/illrkd/?callback=?",
              $("#cm_email").serialize(),
                function (data) {
                    if (data.Status === 400) {
                        e.preventDefault();
                        alert("Please try again later.");
                    }
            });  
            $.ajax({
                url: host+"/newsletter_no_captcha",
                type: "POST",
                data: data,
                success: function(data) {
                    window.location.href="/contest_thank_you";
                },
                error: function(data){
                 // alert("There was an issue with submitting the contest entry. Please try again at a later time.")
                    window.location.href="/contest_thank_you";
                }
            });
        }
        
        function randomgen() {
            var rannumber='';
            for(ranNum=1; ranNum<=6; ranNum++){
                rannumber+=Math.floor(Math.random()*10).toString();
            }
            $('#verifyNum').html(rannumber);
            $('#verifyNumHidden').val(rannumber);
        }
    
        
        function renderPageData(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            if (type == "contestDetails"){
                collection.alt_photo_url = getImageURL(collection.photo_url)
                collection.property_id = getPropertyID();
                item_list.push(collection);
                collection = []
                collection = item_list;
            }
            $.each( collection , function( key, val ) {
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
    
            });
            
            $(container).show();
            $(container).html(item_rendered.join(''));
        };

        loadMallData(renderAll);  
        
        
        
        
        function verify_required_fields (){
            if ($("#first_name").val() != "" && $("#last_name").val() != "" && $("#email").val() != "" && $("#phone").val() != "" && $("#postal_code").val() != "" && $("#birthday").val() != "") {
                return true;
            } else {
                return false;
            }
        }
        
        function check_email (){
            var email = $("#fieldEmail").val();
            if( !validateEmail(email)) {
                return false
            } else {
                return true
            }
        }
        
        function validateEmail($email) {
          var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
          if( !emailReg.test( $email ) ) {
            return false;
          } else {
            return true;
          }
        }
        function renderContest(container, template, collection){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            console.log(collection);
            collection.alt_photo_url = getImageURL(collection.photo_url);
            collection.property_name = getPropertyDetails().name;
            var rendered = Mustache.render(template_html,collection);
            item_rendered.push(rendered);
            
            $(container).show();
            $(container).html(item_rendered.join(''));
        }
        
        // loadMallDataCached(renderPageData);
    });
    $(window).load(function(e){
        function randomgen() {
            var rannumber='';
            for(ranNum=1; ranNum<=6; ranNum++){
                rannumber+=Math.floor(Math.random()*10).toString();
            }
            $('#verifyNum').html(rannumber);
            $('#verifyNumHidden').val(rannumber);
            console.log($('#verifyNum').html());
        }
        randomgen();
        show_content();
    });
</script>